#!/usr/bin/env python
# 
# Copyright 2009 Mark Fiers, Plant & Food Research
# 
# This file is part of Moa - http://github.com/mfiers/Moa
# 
# Moa is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free
# Software Foundation, either version 3 of the License, or (at your
# option) any later version.
# 
# Moa is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
# or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public
# License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with Moa.  If not, see <http://www.gnu.org/licenses/>.
# 
"""
moa frontend

This script serves as a command dispatcher for all moa functionality

"""

import os
import re
import sys
import site
import shutil
import pprint
import optparse
import textwrap
import subprocess

#moa specific libs - first prepare for loading libs
if not os.environ.has_key('MOABASE'):
    raise Exception("MOABASE is undefined")

#process the .pth file in the $MOABASE/bin folder !
site.addsitedir(os.path.join(os.environ['MOABASE'], 'lib', 'python'))

MOABASE = os.environ["MOABASE"]
TEMPLATEDIR = os.path.join(MOABASE, 'template')

##
## Read the moa configutation file 
ETC = {}
for line in open(os.path.join(MOABASE, 'etc', 'moa.conf.mk')).readlines():
    line = line.strip()
    if not line: 
        continue
    if line[0] == '#': 
        continue
    l = [x.strip() for x in re.split("\+?=", line, maxsplit=1)]
    if len(l) == 2:
        ETC[l[0]] = l[1]
moaPlugins = ETC['moa_plugins'].split()

import moa.job
import moa.archive
from moa import runMake
import moa.conf
import moa.info
import moa.api
import moa.unittests
from moa import utils
from moa.exceptions import *
from moa.checkTemplate import checkTemplate

## Init the logger
import moa.logger
l = moa.logger.l
#quick hack to set verbosity
if '-v' in sys.argv:
    moa.logger.setVerbose()

import moa.plugin.git
## read plugin code
moaPluginsLoaded = []
moaPluginModules = {}
for plugin in moaPlugins:
    pyModule = 'moa.plugin.%s' % plugin
    try:
        _m =  __import__( pyModule, globals(), locals(), ['git'], -1)
        moaPluginModules[plugin] = _m
        moaPluginsLoaded.append(plugin)
        l.debug("Successfully Loaded module %s" % pyModule)
    except ImportError, e:
        if not str(e) == "No module named %s" % plugin:
            raise

## Command definitions
moaCommands = {
    'list' : 'List all known templates',
    'set'  : 'Set or append to a configuration value. Variables should be defined as ' +
             'KEY=VALUE pairs on the command-line',
    'help' : 'Display help on the current job (not this help!)',
    'show' : 'Display the currently set variables',
    'run'  : 'Execute Moa, this runs the default action',    
    }

for p in moaPluginsLoaded:
    moaPluginModules[p].defineCommands(moaCommands)
    
USAGE = "Usage: %prog [options] COMMAND ARGUMENTS\n\nCommands:\n"
_commands = moaCommands.keys()
_commands.sort()
for _c in _commands:
    USAGE += "\n".join(
        textwrap.wrap(
            '%s: %s' % (_c, moaCommands[_c]),
            initial_indent=' ',
            subsequent_indent = '   ')) + "\n"

## define & parse command line options  
parser = optparse.OptionParser(usage=USAGE)

parser.add_option('-f', '--force', dest='force', action='store_true',
                  help = 'Force an action, if applicable.')

parser.add_option("-v", "--verbose", dest="verbose",
                  action="store_true", help="verbose output")

parser.add_option("--bg", dest="background",
                  action="store_true", help="Run moa in the background")

parser.set_defaults(threads=1)
parser.add_option("-j", dest="threads",
                  help="threads to use when running Make (corresponds " +
                  "to the make -j parameter)")

parser.add_option("-B", dest="remake", action='store_true',
                  help="Reexecute all targets (corresponds to make -B) ")

parserN = optparse.OptionGroup(parser, "Moa new")
parser.set_defaults(title="", directory=".")

parserN.add_option("-t", "--title", dest="title", help="Job title")
parserN.add_option("-d", "--directory", dest="directory",
                  help="Directory to create the new template in (default: .)")
parser.add_option_group(parserN)

for p in moaPluginsLoaded:
    moaPluginModules[p].defineOptions(parser)

(options, args) = parser.parse_args()

for p in moaPluginsLoaded:
    moaPluginModules[p].prepare(globals())



if options.verbose:
    moa.logger.setVerbose()

##Check for deprecate template style
checkTemplate(os.getcwd())

#make sure the MOA_THREADS env var is set - this is used by MOA later
extraMakeParameters = []

# threads need to be treated different from the other parameters.
# multi-threaded operation is only allowed in the second phase
# execution.
os.putenv('MOA_THREADS', "%s" % options.threads)

if options.remake:
    extraMakeParameters.append('-B')

##
## Command dispatch
## 
if __name__ == "__main__":    
    l.debug("MOABASE : %s" % MOABASE)

    if len(args) == 0:
        rc = runMake.go(verbose = options.verbose,
                        threads = options.threads,
                        extraMakeParameters = extraMakeParameters,                        
                        background = options.background)
        sys.exit(rc)

    command = args[0]
    newargs = args[1:]
    l.debug("start moa %s" % command)
    l.debug("with args %s" % args[1:])

    if command == 'run':
        rc = runMake.go(target = command,
                        makeArgs=newargs,
                        verbose=options.verbose,
                        threads = options.threads,
                        extraMakeParameters = extraMakeParameters,
                        background = options.background)
        sys.exit(rc)
    elif command == 'rawinfo':
        pprint.pprint(moa.info.info(os.getcwd()))
    elif command == 'status':
        print moa.api.status(os.getcwd())
        
    #Create new jobs
    elif command == 'job':
        moa.job.handler(options, newargs)
    elif command == 'new':
        #shortcut for moa job new
        moa.job.handler(options, args)

    #utilities
    elif command == 'ren':
        #renumber a moa job
        moa.utils.renumber(os.getcwd(), args[1], args[2])
    #pack & unpack trees
    elif command == 'archive':
        moa.archive.handler(options, newargs)
    elif command == 'list':
        #shortcut for moa job list
        for job in moa.job.list():
            print job
    #configuration stuff
    elif command == '__set':
        moa.conf.handler(options, args)
    elif command == '__get':
        moa.conf.handler(options, args)
    #unittests
    elif command == 'test':
        moa.unittests.run(options, newargs)
    else:
        #fire arguments of to make
        rc = runMake.go(target = command,
                        makeArgs=args,
                        threads = options.threads,
                        background = options.background,
                        extraMakeParameters = extraMakeParameters,
                        verbose=options.verbose)
        sys.exit(rc)
    utils.exit()
