<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
	<title>MOA - Makefiles in bioinformatics</title>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<link href="moa.css" rel="stylesheet" type="text/css">
	<link rel="icon" type="image/ico" href="favicon.ico">

  </head>
  <body>
	<center>
	  <div id="wrapper">
		<div style="width: 815px;">
		  <div style="clear: left;">
			<div style="float: left; vertical-align:text-bottom">
			  <img id="menulogo" align="middle" src="images/moa_logo_title.png">
			</div>
			<div style="float: right;">
			  <a href="http://www.plantandfood.co.nz/">
				<img src="images/pfr_logo.jpg" alt="" height="87" width="351" border="0">
			</a>
			</div>
		  </div>
		  <div style="clear: left;">
			<div style="float: left; width: 715px; height: 31px; background-color: rgb(81, 0, 45);">
			  &nbsp;&nbsp;
			</div>
			<div style="float: left;">
			  <img src="images/scoop.jpg" alt="" height="31" width="100" border="0">
			</div>
		  </div>
		</div>
		<div style="clear: left;">
		  <div id="left">
			<div style="width: 160px;">
			  <div style="text-align: right;">
                 <a href="introduction.html">Introduction</a><br>
                 <a href="installation.html">Installation</a><br>
                 <a href="extending.html">Extend Moa</a><br>
                 <a href="reference.html">Reference</a><br>
                 <hr>
                 <a href="moa_manual.pdf">Manual in PDF</a>
                 <hr>
                 <a href="api/index.html">Python API</a><br>
			  </div>
			</div>
		  </div>
		  <div id="center_content">
			<div id="homepage_container">
			
<h1 id="chapterTitle">Extending Moa</h1>
<p
>This chapter describes how to create new templates for use with Moa. Creating a basic template is not difficult, once you have a basic understanding of how Makefiles work. Probably the hardest part is ensuring that templates are able to interact with other templates.</p
><div id="creating-a-simple-template---example"
><h1
  >Creating a simple template - example</h1
  ><p
  >A template is, as stated, basically a Makefile that adheres to a set of standards. To understand how Makefiles work, please read the <a href="http://www.gnu.org/software/make/manual/make.html"
    >Gnu Make Manual</a
    >. Note that creating Makefiles can be somewhat complex at first, given that the logic differs from scripting languages. The easiest way to do this is to work from an existing Makefile.</p
  ><p
  >Each template exists of two parts:</p
  ><ul
  ><li
    >Definitions</li
    ><li
    >Implementation</li
    ></ul
  ><p
  >This order is very important! Parts of the Moa core are included inbetween the definitions and the implementation. Getting the order wrong might cripple your template.</p
  ><p
  >In the remainder of this chapter we will describe how to implement a new tool base on a simple example that creates the reverse complement of a <a href="http://en.wikipedia.org/wiki/FASTA_format"
    >FASTA</a
    > sequence using the <a href="http://emboss.sourceforge.net/"
    >EMBOSS</a
    > <a href="http://emboss.sourceforge.net/apps/release/6.1/emboss/apps/revseq.html"
    >revseq</a
    > utility.</p
  ><p
  >All templates are stored in the <code
    >$MOABASE/template</code
    > directory. This template will be stored under the name <code
    >revseq.mk</code
    >.</p
  ><div id="definitions"
  ><h2
    >Definitions</h2
    ><p
    >Each template start with including the first part of the Moa core:</p
    ><pre
    ><code
      >include $(MOABASE)/template/moa/prepare.mk
</code
      ></pre
    ><p
    ><code
      >moaBasePre</code
      > defines a set of default Moa variables and has some macro's that make variable definition easier. The template defintion continues by defining a set of variables used in the latter part of the template.</p
    ></div
  ><div id="describing-the-new-template"
  ><h2
    >Describing the new template</h2
    ><p
    >The following variables define what your template does. These variables are used in generating the help files, the manual and the website.</p
    ><table
    ><thead
      ><tr class="header"
	><th align="left"
	  >Identifier</th
	  ><th align="left"
	  >Description</th
	  ></tr
	></thead
      ><tbody
      ><tr class="odd"
	><td align="left"
	  >moa_title</td
	  ><td align="left"
	  >A short title for this template</td
	  ></tr
	><tr class="even"
	><td align="left"
	  >moa_description</td
	  ><td align="left"
	  >A short description of this template</td
	  ></tr
	></tbody
      ></table
    ><p
    >For our Revseq example:</p
    ><pre
    ><code
      > moa_title = Revseq
 moa_description = This Moa template takes a set of      \
   input FASTA sequences and determines the reverse      \
   complement using the EMBOSS revseq utility.
 moa_ids += revcom
</code
      ></pre
    ><p
    >Note that lines are allowed to break over multiple lines, given that each line that continues to the next line ends with a backslash. No spaces are allowd after the backslash. Indenting the next line is not necessary, but it does enhance readability.</p
    ><div id="namespace-definition:-moa_ids"
    ><h3
      >namespace definition: <code
	>moa_ids</code
	></h3
      ><p
      >Each MOA template defines a set of variables and targets (things to do). These variables and targets (usually) share a single id in their name. In the case of template variables this is a convention, making templates easier to read. Targets, however, are often executed automatically, based on the expected name. A <code
	>moa_id</code
	> is defined in the following way (for our example):</p
      ><pre
      ><code
	>moa_ids += revseq
</code
	></pre
      ><p
      >A <code
	>moa_id</code
	> should be unique and is ideally short and consise. It is also advisable to save the template under the same name.</p
      ></div
    ><div id="job-specific-variables"
    ><h3
      >job specific variables</h3
      ><p
      >The next part of the definitions can be used freely to define variables to be used in the implementation. Each of these variables, ideally, start with the <code
	>moa_id</code
	> (but this is not enforced). The advantage of defining variables here is that they will be accessible via the command line and the API. For example, you can set a define variable using the following command line:</p
      ><pre
      ><code
	>moa set title='Descriptive title'    
</code
	></pre
      ><p
      >There are two types of variables that can be defined: mandatory and optional.</p
      ><table
      ><thead
	><tr class="header"
	  ><th align="left"
	    >Identifier</th
	    ><th align="left"
	    >Description</th
	    ></tr
	  ></thead
	><tbody
	><tr class="odd"
	  ><td align="left"
	    >moa_title</td
	    ><td align="left"
	    >The title for this template</td
	    ></tr
	  ><tr class="even"
	  ><td align="left"
	    >moa_description</td
	    ><td align="left"
	    >A short description of this template</td
	    ></tr
	  ><tr class="odd"
	  ><td align="left"
	    >moa_ids</td
	    ><td align="left"
	    >A unique, short, identifier for this template</td
	    ></tr
	  ></tbody
	></table
      ><p
      >Most templates will have variables specific to the job. These can be defined by</p
      ></div
    ><div id="optional-job-specific-variables"
    ><h3
      >optional job specific variables</h3
      ></div
    ></div
  ><div id="include-the-moa-core-library"
  ><h2
    >Include the moa core library</h2
    ><p
    >To include the core moa library, the following line needs to be added to the Makefile</p
    ><pre
    ><code
      >include $(shell echo $$MOABASE)/template/moa.core.mk
</code
      ></pre
    ></div
  ><div id="implementation"
  ><h2
    >Implementation</h2
    ></div
  ><div id="define-targets"
  ><h2
    >define targets</h2
    ><p
    >Each task, identified by a unique moa_id, needs to define a set of four targets. For example, if your template defines: <code
      >moa_id += revomp</code
      > then the following four targets are expected to be defined and are automatically executed:</p
    ><ul
    ><li
      >$(moa_id): revcomp</li
      ><li
      >$(moa_id)_prepare: revcomp_prepare</li
      ><li
      >$(moa_id)_post - revcomp_post</li
      ><li
      >$(moa_id)_clean - revcomp_clean</li
      ></ul
    ><p
    >Each of these targets must be defined in a new template, although they could can be empty. In the following paragraphs, each of these targets are discussed, in the order that they are executed.</p
    ><div id="prepare-execution:-revcomp_prep"
    ><h3
      >Prepare execution: revcomp_prep</h3
      ><p
      >The MOA_ID_prep target contains commands that are executed prior to the main run. In the case of reverse complementing sequences this target can be used to create a directory to store the output sequences. Using a separate subdirectory to</p
      ></div
    ><div id="round-up-execution:-revcomp_post"
    ><h3
      >Round up execution: revcomp_post</h3
      ></div
    ><div id="clean-up:-revcomp_clean"
    ><h3
      >Clean up: revcomp_clean</h3
      ><ul
      ><li
	><p
	  ><strong
	    >revcomp</strong
	    >: the main target, executes the main task of this template. In this case it takes a set of input sequences and write the reverse complement back to disk.</p
	  ></li
	><li
	><p
	  ><strong
	    >revcomp_prepare</strong
	    >:</p
	  ></li
	><li
	><p
	  ><strong
	    >revcomp_post</strong
	    >: Optional commands to be exeucted after everything is finished. In the case of reverse complementing a set of sequences there is not much to do. The BLAST template, however, uses this target to create an overall BLAST report</p
	  ></li
	><li
	><p
	  ><strong
	    >revcomp_clean</strong
	    >: Cleans up all reverse complemented sequences</p
	  ></li
	></ul
      ></div
    ></div
  ></div
><div id="reference"
><h1
  >Reference</h1
  ><div id="moa-makefile-load-order"
  ><h2
    >Moa Makefile load order</h2
    ><p
    >Makefiles are sensitive to the order in which definitions are made, and thus the order in which the include files are loaded. Moa broadly recognizes two stages: &quot;definition&quot; and &quot;implementation&quot;. The implementation phase starts once the moa core library is loaded.</p
    ><p
    >Moa makefile load starts with loading the template makefile in the current work directory. This Makefile loads a number of other makefiles that load more Makefiles. The following list shows a detailed load order</p
    ><ul
    ><li
      ><strong
	>Makefile</strong
	>: The Makefile in the working directory<ul
	><li
	  ><p
	    ><strong
	      >prepare.mk</strong
	      >: initial definitions. At the start of the prepare.mk file the following files are loaded:</p
	    ><ul
	    ><li
	      ><strong
		>gmsl</strong
		>: The <a href="http://gmsl.sourceforge.net/"
		>GNU Make Standard library</a
		>, a number of utilities for use in Makefiles.</li
	      ><li
	      ><strong
		>global configuration</strong
		> (<code
		>$(MOABASE)/etc/moa.conf</code
		>): This file loads the global default configuration file ( <code
		>$(MOABASE)/etc/moa.conf.mk.default</code
		>)</li
	      ><li
	      ><strong
		>Project configuration</strong
		>: (if present). Moa attempts to find this in the first parent directory of the current working directory that contains a moa project with template &quot;project&quot;.</li
	      ><li
	      ><strong
		>Local configuration</strong
		> (<code
		>moa.mk</code
		>)</li
	      ><li
	      ><strong
		>Plugin definitions</strong
		>: For each plugin name defined in the variable <code
		>moa_plugins</code
		>, moa attempts to load a file called <code
		>$(MOABASE)/template/moa/plugins/PLUGINNAME_def.mk</code
		>.</li
	      ></ul
	    ><p
	    >Once these files are loaded, more Moa specific definitions follow in <code
	      >prepare.mk</code
	      ></p
	    ></li
	  ><li
	  ><p
	    ><strong
	      >template Makefile</strong
	      >: (<code
	      >$(MOABASE)/template/TEMPLATENAME.mk</code
	      >) A makefile specific for the job at hand. This template Makefile might attempt to load prepare.mk, unless it was already loaded earlier. The first part of the template Makefile is used for defining template specific variables.</p
	    ><p
	    >The definition phase of a Moa Makefile is concluded by loading:</p
	    ><ul
	    ><li
	      ><strong
		>Moa core</strong
		> (<code
		>$(MOABASE)/template/moa/core.mk</code
		>). The first thing the Moa core libraries do is loading a set of plugins:<ul
		><li
		  ><strong
		    >Plugin cores</strong
		    >: (<code
		    >$(MOABASE)/template/moa/plugins/PLUGINNAME.mk</code
		    >)</li
		  ></ul
		></li
	      ></ul
	    ><p
	    >After the plugins are loaded moa defines a number of core targets, most importantly, the default target that defines the execution order (see the next paragraph). As much of the functionality as possible is definined as a plubin.</p
	    ></li
	  ></ul
	>Once the core library has loaded, the template specific targets are parsed.</li
      ></ul
    ></div
  ><div id="execution-order"
  ><h2
    >Execution order</h2
    ><div id="run"
    ><h3
      >Run</h3
      ><ul
      ><li
	><code
	  >moa_hooks_prewelcome</code
	  ></li
	><li
	><code
	  >moa_welcome</code
	  ></li
	><li
	><code
	  >moa_hooks_precheck</code
	  ></li
	><li
	><code
	  >moa_check</code
	  ></li
	><li
	><code
	  >moa_prepare</code
	  ></li
	><li
	><code
	  >$(moa_id)_prepare</code
	  ></li
	><li
	><code
	  >$(moa_id)</code
	  ></li
	><li
	><code
	  >$(moa_id)_post</code
	  ></li
	><li
	>moa_post</li
	></ul
      ></div
    ></div
  ><div id="environment-variables"
  ><h2
    >Environment variables</h2
    ><p
    >These environment variables are used by Moa:</p
    ><dl
    ><dt
      ><code
	>MOAANSI</code
	></dt
      ><dd
      ><p
	>The default is to use (ANSI) colored characters in the output. To prevent this from happening, set this (environment) variable to <code
	  >no</code
	  >.</p
	></dd
      ><dt
      ><code
	>MOAPROJECTROOT</code
	></dt
      ><dd
      ><p
	>The root of a moa project - project root is a parent directory of the current directoy that has a moa job with template <code
	  >project</code
	  >. If there is no project root, this variable is undefined.</p
	></dd
      ></dl
    ></div
  ><div id="global-functions"
  ><h2
    >Global functions</h2
    ><p
    >These function are meant to be used at the top level of a Makefile (meaning, not inside a target command block). Function can be called using:</p
    ><pre
    ><code
      >$(call FUNCTIONNAME,ARGUMENT1,ARGUMENT2,...)
</code
      ></pre
    ><dl
    ><dt
      ><code
	>$(call moa_fileset_define,ID,EXTENSION,HELP)</code
	></dt
      ><dd
      ><p
	>Define a set of files to be recoginized by Moa.</p
	></dd
      ><dt
      ><code
	>$(call moa_fileset_remap,INPUT_ID,OUTPUT_ID,OUTPUT_EXTENSION)</code
	></dt
      ><dd
      ><p
	>Remap a set of input files to ....</p
	></dd
      ><dt
      ><code
	>$(call moa_fileset_remap_nodir,INPUT_ID,OUTPUT_ID,OUTPUT_EXTENSION)</code
	></dt
      ><dd
      ><p
	>as <code
	  >moa_fileset_remap</code
	  >, but without prefixing the set with a subdirectory</p
	></dd
      ></dl
    ></div
  ><div id="command-functions"
  ><h2
    >Command functions</h2
    ><p
    >The following commands render a command that can be executed inside a target command block</p
    ><dl
    ><dt
      >`$(call echo,TEXT)</dt
      ><dd
      ><p
	>Returns an echo statement for the text with a green block prepended. The color allows for easy recognition of the echo'd statements. Note that these only work within the code block of a target.</p
	></dd
      ><dt
      ><code
	>$(call errr,TEXT)</code
	></dt
      ><dd
      ><p
	>as <code
	  >$(call echo,TEXT)</code
	  >, but with a red marker (error)</p
	></dd
      ><dt
      ><code
	>$(call exer,TEXT)</code
	></dt
      ><dd
      ><p
	>as <code
	  >$(call errr,TEXT)</code
	  >, but exits the Makefile with an error</p
	></dd
      ><dt
      ><code
	>$(call exerUnlock,TEXT)</code
	></dt
      ><dd
      ><p
	>as <code
	  >$(call exer,TEXT)</code
	  >, but remove the Moa lockfile</p
	></dd
      ><dt
      ><code
	>$(call warn,TEXT)</code
	></dt
      ><dd
      ><p
	>as <code
	  >$(call echo,TEXT)</code
	  >, but with a yellow marker</p
	></dd
      ></dl
    ></div
  ><div id="variables"
  ><h2
    >Variables</h2
    ><dl
    ><dt
      >$(comma)</dt
      ><dd
      ><p
	>a comma</p
	></dd
      ><dt
      >$e</dt
      ><dd
      ><p
	>Can be used in place of Makefile &quot;@&quot;. A @ prepended to a command inside a target in a Makefile supresses echoing of that line during execution. If $e is used, then supression is depending on executing moa with the -v (verbose) parameter.</p
	></dd
      ><dt
      >$(empty)</dt
      ><dd
      ><p
	>empty</p
	></dd
      ><dt
      >$(parC)</dt
      ><dd
      ><p
	>parentheses close</p
	></dd
      ><dt
      >$(parO)</dt
      ><dd
      ><p
	>parentheses open</p
	></dd
      ><dt
      >$(sep)</dt
      ><dd
      ><p
	>contains the pipe symbol &quot;|&quot;</p
	></dd
      ><dt
      >$(space)</dt
      ><dd
      ><p
	>a single space</p
	></dd
      ></dl
    ></div
  ></div
>
</div>
</div>
  
<p>&nbsp;</p><div class="footer_text" id="footer">&copy 2009 PLANT &amp; FOOD RESEARCH | <a href="http://www.plantandfood.co.nz/disclaimer/">disclaimer</a></div>
</div>
</div></center>


</body>
</html>
